<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tracker Nutritionnel Quotidien</title>
  <style>
    /* ——— Design tokens ——— */
    :root {
      --bg: #f6f7fb;
      --card: #ffffff;
      --text: #1a1a1a;
      --muted: #6b7280;
      --accent: #0ea5e9;
      --accent-2: #2563eb;
      --border: #e5e7eb;
      --row-alt: #fafafa;
      --danger: #ef4444;
      --ok: #16a34a;
    }
    * { box-sizing: border-box; }
    html, body { height: 100%; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
      color: var(--text);
      background: var(--bg);
      line-height: 1.5;
    }

    /* ——— Page header ——— */
    .container {
      max-width: 1100px;
      margin: 0 auto;
      padding: 2rem 1rem 4rem;
    }
    header { text-align: center; margin-bottom: 1.5rem; }
    header h1 {
      margin: 0 0 .5rem;
      font-size: clamp(1.5rem, 3.5vw, 2rem);
      letter-spacing: 0.2px;
    }
    header p { margin: 0; color: var(--muted); font-size: 0.95rem; }

    /* ——— Card ——— */
    .card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.25rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    .card h2 {
      font-size: 1.15rem;
      margin: 0 0 .75rem;
    }

    /* ——— Form grid (foods input) ——— */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 1rem 1rem;
    }
    @media (min-width: 720px) { .grid { grid-template-columns: repeat(3, minmax(0, 1fr)); } }
    .field { display: flex; flex-direction: column; gap: .35rem; }
    .field label { font-weight: 600; font-size: 0.95rem; }
    .hint { color: var(--muted); font-size: 0.85rem; }
    input[type="number"], input[type="text"], input[type="password"], select {
      width: 100%;
      padding: .6rem .75rem;
      border: 1px solid var(--border);
      border-radius: 8px;
      background: #fff;
      font-size: 1rem;
    }
    input[type="number"]:focus, input[type="text"]:focus, input[type="password"]:focus, select:focus {
      outline: none;
      border-color: var(--accent-2);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.15);
    }

    /* ——— Actions ——— */
    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: .75rem;
      margin-top: 1rem;
    }
    button {
      appearance: none;
      border: 1px solid var(--border);
      background: var(--accent);
      color: #fff;
      font-weight: 600;
      padding: .6rem .95rem;
      border-radius: 8px;
      cursor: pointer;
      transition: transform .05s ease, box-shadow .15s ease, opacity .2s ease;
    }
    button:hover { box-shadow: 0 4px 14px rgba(14,165,233,0.25); }
    button:active { transform: translateY(1px); }
    .secondary { background: #fff; color: var(--text); }
    .danger { background: var(--danger); color: #fff; }
    .ok { background: var(--ok); color: #fff; }

    /* ——— Table ——— */
    .table-wrap { overflow-x: auto; }
    table {
      width: 100%;
      border-collapse: collapse;
      border: 1px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      background: #fff;
    }
    caption {
      caption-side: top;
      padding: .75rem;
      font-weight: 700;
      text-align: left;
    }
    thead th {
      text-align: left;
      background: #f3f4f6;
      border-bottom: 1px solid var(--border);
      padding: .65rem .75rem;
      font-size: 0.95rem;
    }
    tbody td {
      border-bottom: 1px solid var(--border);
      padding: .6rem .75rem;
      vertical-align: middle;
    }
    tbody tr:nth-child(even) td { background: var(--row-alt); }
    tfoot td {
      font-weight: 700;
      background: #eef6ff;
      border-top: 2px solid var(--accent);
      padding: .7rem .75rem;
    }

    /* ——— Helper ——— */
    .note { margin-top: .75rem; color: var(--muted); font-size: 0.85rem; }
    .subtle { color: var(--muted); font-size: 0.85rem; }
    .inline-actions { display: flex; gap: .5rem; align-items: center; }
    .kbd {
      display: inline-block; padding: 0 .35rem; border: 1px solid var(--border); border-radius: 4px; background: #fff; font-size: 0.85rem;
    }

    /* ——— Gate (password section) ——— */
    .gate {
      display: flex;
      gap: .5rem;
      align-items: center;
      margin-top: .75rem;
    }
    .hidden { display: none; }
  </style>
</head>
<body>
  <main class="container" aria-labelledby="title">
    <header>
      <h1 id="title">Tracker Nutritionnel Quotidien</h1>
      <p>Entrez les quantités, calculez les macros. Le tableau est en bas. Éditez le dictionnaire protégé par mot de passe.</p>
    </header>

    <!-- ——— Inputs ——— -->
    <section class="card" aria-labelledby="form-title">
      <h2 id="form-title">Saisie des quantités</h2>

      <!-- Form simple : inputs numériques générés dynamiquement depuis le dictionnaire -->
      <form id="nutrition-form" autocomplete="off">
        <div class="grid" id="inputsGrid">
          <!-- Champs d'entrée injectés par JS -->
        </div>

        <div class="actions" aria-label="Actions">
          <button type="button" id="calculateBtn" aria-label="Calculer les apports">Calculer</button>
          <button type="button" class="secondary" id="resetBtn" aria-label="Réinitialiser">Réinitialiser</button>
        </div>
      </form>

      <p class="note">Calcul basé sur des valeurs fixes par 100 g (ou par unité). Tout se met à jour sans rechargement.</p>
    </section>

    <!-- ——— Results table (placed below inputs, above editor) ——— -->
    <section class="card table-wrap" aria-labelledby="table-title" style="margin-top:1rem;">
      <h2 id="table-title">Récapitulatif nutritionnel</h2>
      <table id="resultTable">
        <caption>Apports par aliment et totaux</caption>
        <thead>
          <tr>
            <th scope="col">Aliment</th>
            <th scope="col">Quantité</th>
            <th scope="col">Calories (kcal)</th>
            <th scope="col">Protéines (g)</th>
            <th scope="col">Glucides (g)</th>
            <th scope="col">Lipides (g)</th>
          </tr>
        </thead>
        <tbody id="tableBody"><!-- Lignes injectées par JS --></tbody>
        <tfoot>
          <tr>
            <td>Total</td>
            <td id="totalQty">—</td>
            <td id="totalKcal">0</td>
            <td id="totalProt">0</td>
            <td id="totalCarb">0</td>
            <td id="totalFat">0</td>
          </tr>
        </tfoot>
      </table>
    </section>

    <!-- ——— Editor gate + dictionary editor (password protected) ——— -->
    <section class="card" aria-labelledby="dict-title" style="margin-top:1rem;">
      <h2 id="dict-title">Dictionnaire des aliments (protégé)</h2>
      <p class="subtle">Note: sur une page statique, le mot de passe est vérifié côté client. Il empêche l’accès casual mais n’est pas une sécurité forte. Pour une vraie protection, utilisez une authentification côté serveur.</p>

      <!-- Gate controls -->
      <div class="gate" id="gateControls">
        <input id="gatePassword" type="password" placeholder="Mot de passe" aria-label="Mot de passe" />
        <button type="button" class="ok" id="gateUnlockBtn">Déverrouiller</button>
        <button type="button" class="secondary" id="gateSetHashBtn" title="Définir le hash">Définir le hash</button>
        <span class="subtle">Le hash est stocké dans votre navigateur (localStorage).</span>
      </div>

      <!-- Gate feedback -->
      <p id="gateMsg" class="subtle"></p>

      <!-- Editor content (hidden until unlocked) -->
      <div id="editorSection" class="hidden">
        <!-- Liste éditable des aliments -->
        <div id="foodList"></div>

        <!-- Formulaire d’ajout/modification -->
        <div class="card" style="margin-top:1rem;">
          <h3 style="font-size:1rem;margin:0 0 .5rem;">Ajouter ou modifier un aliment</h3>
          <!--
            Champs:
            - key (identifiant unique, sans espaces)
            - label (nom affiché)
            - unit ("g" ou "count")
            - ref ("per100" ou "perUnit")
            - kcal, prot, carb, fat (référence par 100g ou par unité)
          -->
          <form id="editorForm" autocomplete="off">
            <div class="grid" style="grid-template-columns: repeat(2, minmax(0, 1fr));">
              <div class="field">
                <label for="edKey">Identifiant</label>
                <span class="hint">Sans espaces, unique (ex: fromageBlanc3)</span>
                <input id="edKey" type="text" required />
              </div>
              <div class="field">
                <label for="edLabel">Nom affiché</label>
                <input id="edLabel" type="text" required />
              </div>
              <div class="field">
                <label for="edUnit">Unité</label>
                <select id="edUnit" required>
                  <option value="g">g (par 100 g)</option>
                  <option value="count">count (par unité)</option>
                </select>
              </div>
              <div class="field">
                <label for="edRef">Référence</label>
                <select id="edRef" required>
                  <option value="per100">per100</option>
                  <option value="perUnit">perUnit</option>
                </select>
              </div>
              <div class="field">
                <label for="edKcal">Calories (kcal)</label>
                <input id="edKcal" type="number" min="0" step="0.01" required />
              </div>
              <div class="field">
                <label for="edProt">Protéines (g)</label>
                <input id="edProt" type="number" min="0" step="0.01" required />
              </div>
              <div class="field">
                <label for="edCarb">Glucides (g)</label>
                <input id="edCarb" type="number" min="0" step="0.01" required />
              </div>
              <div class="field">
                <label for="edFat">Lipides (g)</label>
                <input id="edFat" type="number" min="0" step="0.01" required />
              </div>
            </div>
            <div class="actions">
              <button type="submit" class="ok" id="saveFoodBtn">Enregistrer</button>
              <button type="button" class="secondary" id="clearEditorBtn">Effacer le formulaire</button>
            </div>
            <p class="subtle">Astuce: cliquez sur “Modifier” dans la liste pour pré-remplir les champs. Supprimez un aliment pour le retirer.</p>
          </form>
        </div>
      </div>
    </section>
  </main>

  <script>
    // —————————————————————————————————————————————————————————————
    // Dictionnaire par défaut + persistance locale
    // Ajout "Fromage blanc 3%" (par 100 g): 62 kcal, 8.5 prot, 3.9 gluc, 3.0 lip.
    // —————————————————————————————————————————————————————————————
    const DEFAULT_FOODS = {
      fruitsRouges: { label: "Fruits rouges", unit: "g", ref: "per100", kcal: 43, prot: 1.0, carb: 10.0, fat: 0.3 },
      banane: { label: "Banane", unit: "count", ref: "perUnit", kcal: 89, prot: 1.1, carb: 23.0, fat: 0.3 },
      floconsAvoine: { label: "Flocons d'avoine", unit: "g", ref: "per100", kcal: 389, prot: 17.0, carb: 66.0, fat: 7.0 },
      huileOlive: { label: "Huile d'olive", unit: "g", ref: "per100", kcal: 884, prot: 0.0, carb: 0.0, fat: 100.0 },
      lentilles: { label: "Lentilles en conserve", unit: "g", ref: "per100", kcal: 116, prot: 9.0, carb: 20.0, fat: 0.4 },
      patesCrues: { label: "Pâtes (crues)", unit: "g", ref: "per100", kcal: 371, prot: 13.0, carb: 75.0, fat: 1.5 },
      steakHache: { label: "Steak haché (15% MG)", unit: "g", ref: "per100", kcal: 250, prot: 20.0, carb: 0.0, fat: 18.0 },
      escalopeVolaille: { label: "Escalope de poulet/dinde", unit: "g", ref: "per100", kcal: 110, prot: 23.0, carb: 0.0, fat: 1.5 },
      fromageBlanc3: { label: "Fromage blanc 3%", unit: "g", ref: "per100", kcal: 62, prot: 8.5, carb: 3.9, fat: 3.0 }
    };

    const STORAGE_FOODS = "nutritionFoodsV1";
    const STORAGE_HASH  = "nutritionEditorHashV1"; // SHA-256 hex string
    const inputRefs = {};
    const toNumber = (v) => {
      const n = Number(v);
      return Number.isFinite(n) && n >= 0 ? n : 0;
    };
    const round2 = (v) => Math.round(v * 100) / 100;

    function loadFoods() {
      try {
        const raw = localStorage.getItem(STORAGE_FOODS);
        if (!raw) return { ...DEFAULT_FOODS };
        const parsed = JSON.parse(raw);
        return { ...DEFAULT_FOODS, ...parsed };
      } catch {
        return { ...DEFAULT_FOODS };
      }
    }
    function saveFoods(foods) {
      localStorage.setItem(STORAGE_FOODS, JSON.stringify(foods));
    }

    // ——— Crypto utils: SHA-256 hex ———
    async function sha256Hex(text) {
      const enc = new TextEncoder().encode(text);
      const buf = await crypto.subtle.digest("SHA-256", enc);
      const arr = Array.from(new Uint8Array(buf));
      return arr.map(b => b.toString(16).padStart(2, "0")).join("");
    }

    // —————————————————————————————————————————————————————————————
    // État & DOM refs
    // —————————————————————————————————————————————————————————————
    let FOODS = loadFoods();

    const inputsGrid = document.getElementById("inputsGrid");
    const tableBody = document.getElementById("tableBody");
    const totalQtyCell = document.getElementById("totalQty");
    const totalKcalCell = document.getElementById("totalKcal");
    const totalProtCell = document.getElementById("totalProt");
    const totalCarbCell = document.getElementById("totalCarb");
    const totalFatCell = document.getElementById("totalFat");

    const calculateBtn = document.getElementById("calculateBtn");
    const resetBtn = document.getElementById("resetBtn");

    const foodList = document.getElementById("foodList");
    const editorForm = document.getElementById("editorForm");
    const clearEditorBtn = document.getElementById("clearEditorBtn");
    const edKey = document.getElementById("edKey");
    const edLabel = document.getElementById("edLabel");
    const edUnit = document.getElementById("edUnit");
    const edRef = document.getElementById("edRef");
    const edKcal = document.getElementById("edKcal");
    const edProt = document.getElementById("edProt");
    const edCarb = document.getElementById("edCarb");
    const edFat = document.getElementById("edFat");

    const gateControls = document.getElementById("gateControls");
    const gatePassword = document.getElementById("gatePassword");
    const gateUnlockBtn = document.getElementById("gateUnlockBtn");
    const gateSetHashBtn = document.getElementById("gateSetHashBtn");
    const gateMsg = document.getElementById("gateMsg");
    const editorSection = document.getElementById("editorSection");

    // —————————————————————————————————————————————————————————————
    // Calcul macros
    // —————————————————————————————————————————————————————————————
    function computeEntryMacros(item, qty) {
      const proportion = item.ref === "per100" ? qty / 100 : qty;
      return {
        kcal: round2(item.kcal * proportion),
        prot: round2(item.prot * proportion),
        carb: round2(item.carb * proportion),
        fat:  round2(item.fat  * proportion)
      };
    }

    // —————————————————————————————————————————————————————————————
    // Rendu inputs
    // —————————————————————————————————————————————————————————————
    function renderInputs() {
      inputsGrid.innerHTML = "";
      Object.keys(FOODS).forEach((key) => {
        const item = FOODS[key];

        const field = document.createElement("div");
        field.className = "field";

        const label = document.createElement("label");
        label.setAttribute("for", `qty_${key}`);
        label.textContent = item.label;

        const hint = document.createElement("span");
        hint.className = "hint";
        hint.textContent = item.unit === "g" ? "Quantité en g" : "Nombre entier";

        const input = document.createElement("input");
        input.type = "number";
        input.id = `qty_${key}`;
        input.min = "0";
        input.step = "1";
        input.value = "0";
        input.inputMode = "numeric";

        field.appendChild(label);
        field.appendChild(hint);
        field.appendChild(input);
        inputsGrid.appendChild(field);

        inputRefs[key] = input;
        input.addEventListener("input", renderTable);
      });
    }

    // —————————————————————————————————————————————————————————————
    // Rendu tableau
    // —————————————————————————————————————————————————————————————
    function renderTable() {
      tableBody.innerHTML = "";

      let totalKcal = 0, totalProt = 0, totalCarb = 0, totalFat = 0;

      Object.keys(FOODS).forEach((key) => {
        const item = FOODS[key];
        const input = inputRefs[key];
        if (!input) return;
        const qty = toNumber(input.value);

        const macros = computeEntryMacros(item, qty);

        totalKcal += macros.kcal;
        totalProt += macros.prot;
        totalCarb += macros.carb;
        totalFat  += macros.fat;

        const tr = document.createElement("tr");

        const tdFood = document.createElement("td");
        tdFood.textContent = item.label;
        tr.appendChild(tdFood);

        const tdQty = document.createElement("td");
        tdQty.textContent = item.unit === "g" ? `${qty} g` : `${qty} unité${qty > 1 ? "s" : ""}`;
        tr.appendChild(tdQty);

        const tdKcal = document.createElement("td"); tdKcal.textContent = round2(macros.kcal);
        const tdProt = document.createElement("td"); tdProt.textContent = round2(macros.prot);
        const tdCarb = document.createElement("td"); tdCarb.textContent = round2(macros.carb);
        const tdFat  = document.createElement("td"); tdFat.textContent  = round2(macros.fat);

        tr.appendChild(tdKcal); tr.appendChild(tdProt); tr.appendChild(tdCarb); tr.appendChild(tdFat);
        tableBody.appendChild(tr);
      });

      const gramsSum = Object.keys(FOODS)
        .filter(k => FOODS[k].unit === "g")
        .reduce((acc, k) => acc + toNumber(inputRefs[k]?.value || 0), 0);

      const countsSummary = Object.keys(FOODS)
        .filter(k => FOODS[k].unit === "count")
        .map(k => ({ label: FOODS[k].label, n: toNumber(inputRefs[k]?.value || 0) }))
        .filter(x => x.n > 0)
        .map(x => `${x.n} ${x.label.toLowerCase()}`);

      const qtyText = countsSummary.length
        ? `${round2(gramsSum)} g + ${countsSummary.join(" + ")}`
        : `${round2(gramsSum)} g`;

      totalQtyCell.textContent = qtyText;
      totalKcalCell.textContent = round2(totalKcal);
      totalProtCell.textContent = round2(totalProt);
      totalCarbCell.textContent = round2(totalCarb);
      totalFatCell.textContent  = round2(totalFat);
    }

    // —————————————————————————————————————————————————————————————
    // Dictionnaire: liste + actions
    // —————————————————————————————————————————————————————————————
    function renderFoodList() {
      foodList.innerHTML = "";
      const table = document.createElement("table");
      table.style.width = "100%";
      table.style.borderCollapse = "collapse";
      table.style.border = `1px solid var(--border)`;
      table.innerHTML = `
        <thead>
          <tr>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">Identifiant</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">Nom</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">Unité</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">Réf</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">kcal / prot / carb / fat</th>
            <th style="text-align:left;padding:.5rem;border-bottom:1px solid var(--border);background:#f3f4f6;">Actions</th>
          </tr>
        </thead>
        <tbody></tbody>
      `;
      const tbody = table.querySelector("tbody");
      const rowAlt = getComputedStyle(document.documentElement).getPropertyValue('--row-alt').trim() || "#fafafa";

      Object.keys(FOODS).forEach((key, idx) => {
        const it = FOODS[key];
        const tr = document.createElement("tr");
        const alt = idx % 2 ? `background:${rowAlt}` : "";
        tr.innerHTML = `
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">${key}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">${it.label}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">${it.unit}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">${it.ref}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">${it.kcal} / ${it.prot} / ${it.carb} / ${it.fat}</td>
          <td style="padding:.5rem;border-bottom:1px solid var(--border);${alt}">
            <div class="inline-actions">
              <button type="button" class="secondary" data-edit="${key}">Modifier</button>
              <button type="button" class="danger" data-delete="${key}">Supprimer</button>
            </div>
          </td>
        `;
        tbody.appendChild(tr);
      });

      foodList.appendChild(table);

      foodList.querySelectorAll("[data-edit]").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.getAttribute("data-edit");
          const it = FOODS[k];
          edKey.value = k;
          edLabel.value = it.label;
          edUnit.value = it.unit;
          edRef.value = it.ref;
          edKcal.value = it.kcal;
          edProt.value = it.prot;
          edCarb.value = it.carb;
          edFat.value = it.fat;
          edKey.disabled = true;
        });
      });

      foodList.querySelectorAll("[data-delete]").forEach(btn => {
        btn.addEventListener("click", () => {
          const k = btn.getAttribute("data-delete");
          if (!confirm(`Supprimer l'aliment "${k}" ?`)) return;
          delete FOODS[k];
          saveFoods(FOODS);
          rebuildInputsAndTable();
          if (edKey.value === k) clearEditor();
        });
      });
    }

    // —————————————————————————————————————————————————————————————
    // Actions globales
    // —————————————————————————————————————————————————————————————
    calculateBtn.addEventListener("click", renderTable);
    resetBtn.addEventListener("click", () => {
      Object.keys(inputRefs).forEach(k => { inputRefs[k].value = "0"; });
      renderTable();
    });

    function clearEditor() {
      edKey.value = "";
      edLabel.value = "";
      edUnit.value = "g";
      edRef.value = "per100";
      edKcal.value = "";
      edProt.value = "";
      edCarb.value = "";
      edFat.value = "";
      edKey.disabled = false;
    }
    clearEditorBtn.addEventListener("click", clearEditor);

    editorForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const key = edKey.value.trim();
      const label = edLabel.value.trim();
      const unit = edUnit.value;
      const ref  = edRef.value;
      const kcal = toNumber(edKcal.value);
      const prot = toNumber(edProt.value);
      const carb = toNumber(edCarb.value);
      const fat  = toNumber(edFat.value);

      if (!key || !label) { alert("Identifiant et nom requis."); return; }
      if (!/^[A-Za-z0-9_]+$/.test(key)) { alert("Identifiant: lettres/chiffres/underscore uniquement."); return; }
      if (!(unit === "g" || unit === "count")) { alert("Unité invalide."); return; }
      if (!(ref === "per100" || ref === "perUnit")) { alert("Référence invalide."); return; }

      FOODS[key] = { label, unit, ref, kcal, prot, carb, fat };
      saveFoods(FOODS);
      rebuildInputsAndTable();
      if (inputRefs[key]) inputRefs[key].value = inputRefs[key].value || "0";
      clearEditor();
    });

    function rebuildInputsAndTable() {
      const oldValues = {};
      Object.keys(inputRefs).forEach(k => { oldValues[k] = inputRefs[k].value; });
      Object.keys(inputRefs).forEach(k => delete inputRefs[k]);
      renderInputs();
      Object.keys(oldValues).forEach(k => { if (inputRefs[k]) inputRefs[k].value = oldValues[k]; });
      renderFoodList();
      renderTable();
    }

    // —————————————————————————————————————————————————————————————
    // Password gate (client-side)
    // —————————————————————————————————————————————————————————————
    // Flux:
    // - L'utilisateur définit une fois le hash (SHA-256) via "Définir le hash" => stocké en localStorage
    // - Pour déverrouiller, on hash le mot de passe saisi et compare au hash stocké
    // - Si pas de hash défini, l'éditeur reste caché (vous devez le définir sur ce navigateur)
    function updateGateStateMessage() {
      const hasHash = !!localStorage.getItem(STORAGE_HASH);
      gateMsg.textContent = hasHash
        ? "Un hash de mot de passe est défini dans ce navigateur. Entrez le mot de passe pour déverrouiller."
        : "Aucun hash n'est défini. Cliquez sur “Définir le hash” pour créer le hash du mot de passe (stocké localement).";
    }

    gateSetHashBtn.addEventListener("click", async () => {
      const pw = prompt("Entrez le mot de passe à hasher (il ne sera pas stocké, uniquement son hash):");
      if (!pw) return;
      const hex = await sha256Hex(pw);
      localStorage.setItem(STORAGE_HASH, hex);
      updateGateStateMessage();
      alert("Hash défini localement. Conservez votre mot de passe.");
    });

    gateUnlockBtn.addEventListener("click", async () => {
      const stored = localStorage.getItem(STORAGE_HASH);
      if (!stored) {
        alert("Aucun hash défini. Cliquez sur “Définir le hash” d’abord.");
        return;
      }
      const inputPw = gatePassword.value || "";
      const hex = await sha256Hex(inputPw);
      if (hex === stored) {
        editorSection.classList.remove("hidden");
        gateMsg.textContent = "Éditeur déverrouillé.";
        gateControls.classList.add("hidden");
      } else {
        gateMsg.textContent = "Mot de passe incorrect.";
      }
    });

    // —————————————————————————————————————————————————————————————
    // Initialisation
    // —————————————————————————————————————————————————————————————
    renderInputs();
    renderTable();
    updateGateStateMessage();
    // L'éditeur reste caché tant que non déverrouillé
  </script>
</body>
</html>
